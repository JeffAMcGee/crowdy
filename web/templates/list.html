{% extends 'base.html' %}

{% block head_extra %}

<script src="/static/scripts/arbor.js"></script>  
<script src="/static/scripts/crowd_network.js"></script>  

<script>
function loadData(data) {
	var events = jQuery.map(data, function(crowd,i) {
        return {
            'start': new Date(1000*crowd.start),
            'end': new Date(1000*crowd.end),
	    'users': crowd.users,
            'title': crowd._id,
            'description': 'a crowd of '+crowd.size+' people'
        };
        });
        var jq_tbo = $('#dyTableBody');
	var tbo=document.getElementById('dyTableBody');
	for(var i=0;i<events.length;i++){
		row=document.createElement('tr');
		for(var j=0;j<3;j++){
			cell=document.createElement('td');
			switch(j)
			{
				case 0: 
					var date1 = events[i]['start'];
					var date2 = events[i]['end'];
					cell.appendChild(document.createTextNode(date1.getFullYear()+'/'+date1.getMonth()+'/'+date1.getDate()+' '+date1.getHours()+':'+date1.getMinutes()+' To '+date2.getFullYear()+'/'+date2.getMonth()+'/'+date2.getDate()+' '+date2.getHours()+':'+date2.getMinutes())); 
					break;
				case 1: cell.appendChild(document.createTextNode(events[i]['title'])); break;
				case 2: cell.appendChild(document.createTextNode(events[i]['description'])); break;
			}
			row.appendChild(cell);
		}
                tbo.appendChild(row);
                //toggle the detailed view when the user clicks a row
                jq_tbo.children().last().click(
                    {cid:events[i]['title']},
                    function(e) {
                        var detail = $(this).next();
                        detail.slideToggle();
                        var td = detail.children().first();
                        if(!td.contents.length==0) {
                          jQuery.getJSON('/crowd/'+e.data.cid, function(res) {
                              td.html(res.html);
                              loadCrowdPopup(e.data.cid,td,res.users,res.tweets);
                          });
                        }
                    }
                );
                jq_tbo.append('<tr style="display:none"><td colspan="3"></td></tr>');
	}
}

/*
var resizeTimerID = null;
function onResize() {
    if (resizeTimerID == null) {
        resizeTimerID = window.setTimeout(function() {
            resizeTimerID = null;
            tl.layout();
        }, 500);
    }
}
*/



$(document).ready(function() {
    jQuery.getJSON('/api/1/search/crowd?limit=1000', loadData);
    $(window).resize(onResize());
});

function loadSearchResults(data) {
	var events = jQuery.map(data, function(crowd,i) {
        return {
            'start': new Date(1000*crowd.start),
            'end': new Date(1000*crowd.end),
	        'users': crowd.users,
            'title': crowd._id,
            'description': 'a crowd of '+crowd.size+' people'
        };
        });
        var jq_tbo = $('#dyTableBody');


    // Here is the code to generate text "Search results for BLAHBLAH"
    
    var query_title=document.getElementById('query_title');
    query_title.innerHTML = "";

    var searchBox = document.getElementById('searchBox');
    var query = "";
    query = searchBox.value;
    row = document.createElement('tr');
    cell=document.createElement('td');
    //cell.appendChild(document.createTextNode('Results for ' + query));
    cell.appendChild(document.createTextNode('(Demonstration Example) Results for '));
   
    // Emphasize the query text.
    query_text = document.createElement('strong');
    query_text.appendChild(document.createTextNode(query));
    cell.appendChild(query_text);


    row.appendChild(cell);
    query_title.appendChild(row);
    


	var tbo=document.getElementById('dyTableBody');
 
    row = document.createElement('tr');
    th = document.createElement('th');
    th.appendChild(document.createTextNode('Period'));
    row.appendChild(th);
    th = document.createElement('th');
    th.appendChild(document.createTextNode('Tweets'));
    row.appendChild(th);
    th = document.createElement('th');
    th.appendChild(document.createTextNode('Users'));
    row.appendChild(th);
    tbo.appendChild(row);


	for(var i=0;i<events.length;i++){
		row=document.createElement('tr');
		for(var j=0;j<3;j++){
			cell=document.createElement('td');
			switch(j)
			{
				case 0: 
					var date1 = events[i]['start'];
					var date2 = events[i]['end'];
					cell.appendChild(document.createTextNode(date1.getFullYear()+'/'+date1.getMonth()+'/'+date1.getDate()+' '+date1.getHours()+':'+date1.getMinutes()+' To '+date2.getFullYear()+'/'+date2.getMonth()+'/'+date2.getDate()+' '+date2.getHours()+':'+date2.getMinutes())); 
					break;
				case 1: cell.appendChild(document.createTextNode(events[i]['title'])); break;
				case 2: cell.appendChild(document.createTextNode(events[i]['description'])); break;
			}
			row.appendChild(cell);
		}
                tbo.appendChild(row);
                //toggle the detailed view when the user clicks a row
                jq_tbo.children().last().click(
                    {cid:events[i]['title']},
                    function(e) {
                        var detail = $(this).next();
                        detail.slideToggle();
                        var td = detail.children().first();
                        if(!td.contents.length==0) {
                          jQuery.getJSON('/crowd/'+e.data.cid, function(res) {
                              td.html(res.html);
                              loadCrowdPopup(e.data.cid,td,res.users,res.tweets);
                          });
                        }
                    }
                );
                jq_tbo.append('<tr style="display:none"><td colspan="3"></td></tr>');
	}
}

function search() {
    //document.body.innerHTML = "";
	var query_title=document.getElementById('query_title');
    query_title.innerHTML = "";
    var tbo=document.getElementById('dyTableBody');
    tbo.innerHTML="";
    var searchBox = document.getElementById('searchBox');
    var query = "";
    query = searchBox.value;
    row = document.createElement('tr');
    cell=document.createElement('td');
    if (query == "") {
        cell.appendChild(document.createTextNode('Please enter a valid query!'));
        row.appendChild(cell);
        query_title.appendChild(row);
    } else {
        //cell.appendChild(document.createTextNode("The query is:" + query));
        var api = '/api/1/search/crowd?q=' + query + '&limit=5';
        jQuery.getJSON(api, loadSearchResults);
        $(window).resize(onResize());
    }
    //document.appendChild(document.createTextNode("rPlease enter a valid query!"));
    //document.createTextNode("rPlease enter a valid query!");
}

</script>

{% endblock %}

{% block content %}

    <br>
    <div id="header">
    <div id="headerContent">
    <!--
    <div id="logo"><a href="Crowdy Search"><img alt="crowdy-logo-small" src="crowdy-logo-pic" /></a></div>
    -->
    <div id="search_header">
    <div id="searchEntry">
    <input id="searchBox" name="q" placeholder="Enter your query" results="10" type="search" value="" />
    </div>
    <div id="searchButton">
    <!--
    <input type="submit" value="Search" />
    -->
    <input type=BUTTON value="Search" OnClick="search()"/>
    </div>
    <div id="searchOptionsCtrl">
    <a href="/advanced_search" class="litnv">Advanced Search</a>
    </div>
    <p class="clearer"></p>
    </form></div>   </div>
    </div>

    <br>
    
    <div id="mytable">
        <table class="mytable">
            <div id="query_title">
            </div>
            <div id="query_content">
            </div>
            <tbody id="dyTableBody">
                <tr><th>Period</th><th>Tweets</th><th>Users</th></tr>
            </tbody>
        </table>
    </div>
{% endblock %}

