{% extends 'search_base.html' %}

{% block search_head_extra %}

<script type="text/javascript" src="/static/scripts/jquery.strftime-minified.js" charset='utf-8'></script>

<script>

function loadData(data) {
    var events = jQuery.map(data, function(crowd,i) {
        return {
            'start': new Date(1000*crowd.start),
            'end': new Date(1000*crowd.end),
            'users': crowd.users,
            'title': crowd.title,
            '_id':crowd._id,
            'description': ""+crowd.size,
            'size': crowd.size,
            'star' : crowd.star
        };
    });
    var tbo = $('#dyTableBody');
    for(var i=0;i<events.length;i++){
        var row = $('#listTemplate').clone();
        var date1 = $.strftime('%Y/%m/%d %H:%M', events[i]['start']);
        var date2 = $.strftime('%Y/%m/%d %H:%M', events[i]['end']);
        row.find('.listPeriod').text(date1+' To '+date2);
        row.find('.listUsers').text(events[i]['title']);
        row.find('.listSize').text(events[i]['description']);
        row.show()
        tbo.append(row);

        //toggle the detailed view when the user clicks a row
        row.click(
            {cid:events[i]['_id'],star:events[i]['star']},
            function(e) {
                var detail = $(this).next();
                detail.slideToggle();
                var td = detail.children().first();
                if(!td.contents.length==0) {
                  jQuery.getJSON('/crowd/'+e.data.cid, function(res) {
                      td.html(res.html);
                      loadCrowdPopup(e.data.cid,td,res);
                  });
                }
            }
        );
        tbo.append($('#expandTemplate').clone());
    }
}

function search() {
    //document.body.innerHTML = "";
    var query_title=document.getElementById('query_title');
    query_title.innerHTML = "";
    var tbo=document.getElementById('dyTableBody');
    tbo.innerHTML="";
    
    // Here is the code to generate text "Search results for BLAHBLAH"
    
    var query_title=document.getElementById('query_title');
    query_title.innerHTML = "";

    var searchBox = document.getElementById('searchBox');
    var query = "";
    query = searchBox.value;
    row = document.createElement('tr');
    cell=document.createElement('td');
    cell.appendChild(document.createTextNode('Results for ' ));
   
    // Emphasize the query text.
    query_text = document.createElement('strong');
    query_text.appendChild(document.createTextNode(query));
    cell.appendChild(query_text);

    row.appendChild(cell);
    query_title.appendChild(row);

    var api = make_search_url();

    
    var tbo=document.getElementById('dyTableBody');
 
    row = document.createElement('tr');
    th = document.createElement('th');
    th.appendChild(document.createTextNode('Period'));
    row.appendChild(th);
    th = document.createElement('th');
    th.appendChild(document.createTextNode('Tweets'));
    row.appendChild(th);
    th = document.createElement('th');
    th.appendChild(document.createTextNode('Users'));
    row.appendChild(th);
    tbo.appendChild(row);

    jQuery.getJSON(api, loadData);
}




</script>
{% endblock %}


{% block search_results_block %}
    <div id="mytable">

        <table class="mytable">
            <div id="query_title">
            </div>
            <div id="query_content">
            </div>
            <tbody id="dyTableBody">
                <tr><th>Period</th><th>Users</th><th>Size</th></tr>
                <tr id="listTemplate" style="display:none">
                    <td class="listPeriod"></td>
                    <td class="listUsers"></td>
                    <td class="listSize"></td>
                </tr>
                <tr id="expandTemplate" style="display:none">
                    <td colspan="4">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
{% endblock %}

