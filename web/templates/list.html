{% extends 'search_base.html' %}

{% block search_head_extra %}
<script>

function loadData(data) {
	var events = jQuery.map(data, function(crowd,i) {
        return {
            'start': new Date(1000*crowd.start),
            'end': new Date(1000*crowd.end),
	    'users': crowd.users,
            'title': crowd.title,
            '_id':crowd._id,
            'description': ""+crowd.size,
	    'size': crowd.size,

	    'star' : crowd.star
        };
        });
        var jq_tbo = $('#dyTableBody');
	var tbo=document.getElementById('dyTableBody');
	for(var i=0;i<events.length;i++){
		row=document.createElement('tr');
		for(var j=0;j<3;j++){
			cell=document.createElement('td');
			switch(j)
			{
				case 0: 
					var date1 = events[i]['start'];
					var date2 = events[i]['end'];
					cell.appendChild(document.createTextNode(date1.getFullYear()+'/'+(date1.getMonth()+1)+'/'+date1.getDate()+' '+date1.getHours()+':'+date1.getMinutes()+' To '+date2.getFullYear()+'/'+(date2.getMonth()+1)+'/'+date2.getDate()+' '+date2.getHours()+':'+date2.getMinutes())); 
					break;
				case 1: cell.appendChild(document.createTextNode(events[i]['title'])); break;
				case 2: cell.appendChild(document.createTextNode(events[i]['description'])); break;
			}
			row.appendChild(cell);
		}
                tbo.appendChild(row);
                //toggle the detailed view when the user clicks a row
                jq_tbo.children().last().click(
                    {cid:events[i]['_id'],star:events[i]['star']},
                    function(e) {
                        var detail = $(this).next();
                        detail.slideToggle();
                        var td = detail.children().first();
                        if(!td.contents.length==0) {
                          jQuery.getJSON('/crowd/'+e.data.cid, function(res) {
                              td.html(res.html);
                              loadCrowdPopup(e.data.cid,td,res.users,res.tweets,e.data.star);
                          });
                        }
                    }
                );
		
                jq_tbo.append('<tr style="display:none"><td colspan="4">Loading...</td></tr>');
	}
}

function search() {
    //document.body.innerHTML = "";
	var query_title=document.getElementById('query_title');
    query_title.innerHTML = "";
    var tbo=document.getElementById('dyTableBody');
    tbo.innerHTML="";
    
    // Here is the code to generate text "Search results for BLAHBLAH"
    
    var query_title=document.getElementById('query_title');
    query_title.innerHTML = "";

    var searchBox = document.getElementById('searchBox');
    var query = "";
    query = searchBox.value;
    row = document.createElement('tr');
    cell=document.createElement('td');
    //cell.appendChild(document.createTextNode('Results for ' + query));
    cell.appendChild(document.createTextNode('(Demo Example) for '));
   
    // Emphasize the query text.
    query_text = document.createElement('strong');
    query_text.appendChild(document.createTextNode(query));
    cell.appendChild(query_text);

    row.appendChild(cell);
    query_title.appendChild(row);

    var api = make_search_url();

    
	var tbo=document.getElementById('dyTableBody');
 
    row = document.createElement('tr');
    th = document.createElement('th');
    th.appendChild(document.createTextNode('Period'));
    row.appendChild(th);
    th = document.createElement('th');
    th.appendChild(document.createTextNode('Tweets'));
    row.appendChild(th);
    th = document.createElement('th');
    th.appendChild(document.createTextNode('Users'));
    row.appendChild(th);
    tbo.appendChild(row);

    jQuery.getJSON(api, loadData);
}




</script>
{% endblock %}


{% block search_results_block %}
    <div id="mytable">

        <table class="mytable">
            <div id="query_title">
            </div>
            <div id="query_content">
            </div>
            <tbody id="dyTableBody">
                <tr><th>Period</th><th>Users</th><th>Size</th></tr>
            </tbody>
        </table>
    </div>
{% endblock %}

